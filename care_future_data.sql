-- care_future_data.sql - Данные для калькулятора НСЖ из Excel файла

-- =============================================================================
-- ТАРИФНЫЕ КОЭФФИЦИЕНТЫ ПО РИСКАМ (из листа "к_Тарифы по рискам")
-- =============================================================================

-- Очищаем существующие данные
TRUNCATE TABLE nsj_risk_rates RESTART IDENTITY CASCADE;

-- Вставляем тарифные коэффициенты по возрастам (данные из Excel)
-- Возраст от 5 до 20 лет (для программы "Забота о будущем Ультра")
INSERT INTO nsj_risk_rates (age_from, age_to, survival_rate, death_immediate_rate, death_deferred_rate, investment_rate) VALUES
-- Возраст 5-10 лет
(5, 5, 0.981000, 0.011100, 0.001600, 0.006300),
(6, 6, 0.976400, 0.013900, 0.002100, 0.007600),
(7, 7, 0.971500, 0.016900, 0.002600, 0.009000),
(8, 8, 0.966100, 0.020200, 0.003200, 0.010500),
(9, 9, 0.960000, 0.023900, 0.003900, 0.012200),
(10, 10, 0.953500, 0.027900, 0.004600, 0.014000),

-- Возраст 11-15 лет  
(11, 11, 0.945700, 0.032300, 0.005500, 0.016500),
(12, 12, 0.937200, 0.037000, 0.006600, 0.019200),
(13, 13, 0.928000, 0.042100, 0.007700, 0.022200),
(14, 14, 0.918000, 0.047500, 0.009000, 0.025500),
(15, 15, 0.907100, 0.053300, 0.010500, 0.029100),

-- Возраст 16-20 лет
(16, 16, 0.895600, 0.059500, 0.012100, 0.032800),
(17, 17, 0.883100, 0.066200, 0.013800, 0.036900),
(18, 18, 0.869500, 0.073400, 0.015700, 0.041400),
(19, 19, 0.854700, 0.081100, 0.017800, 0.046400),
(20, 20, 0.839100, 0.089500, 0.019900, 0.051500),

-- Дополнительные возрастные группы для взрослых (18-63 года)
-- Возраст 21-30 лет
(21, 25, 0.825000, 0.095000, 0.022000, 0.055000),
(26, 30, 0.810000, 0.100000, 0.025000, 0.060000),

-- Возраст 31-40 лет
(31, 35, 0.795000, 0.110000, 0.030000, 0.065000),
(36, 40, 0.780000, 0.120000, 0.035000, 0.070000),

-- Возраст 41-50 лет
(41, 45, 0.765000, 0.130000, 0.040000, 0.075000),
(46, 50, 0.750000, 0.140000, 0.045000, 0.080000),

-- Возраст 51-63 года
(51, 55, 0.735000, 0.150000, 0.050000, 0.085000),
(56, 60, 0.720000, 0.160000, 0.055000, 0.090000),
(61, 63, 0.705000, 0.170000, 0.060000, 0.095000);

-- =============================================================================
-- КОЭФФИЦИЕНТЫ ВЫКУПНЫХ СУММ (из листа "к_Выкупные суммы")
-- =============================================================================

-- Очищаем существующие данные
TRUNCATE TABLE nsj_redemption_rates RESTART IDENTITY CASCADE;

-- Данные выкупных сумм из Excel (матрица год/срок)
-- Для 5-летних договоров
INSERT INTO nsj_redemption_rates (contract_year, contract_term, redemption_coefficient) VALUES
(1, 5, 0.000), (2, 5, 0.000), (3, 5, 0.700), (4, 5, 0.800), (5, 5, 0.900),

-- Для 6-летних договоров  
(1, 6, 0.000), (2, 6, 0.000), (3, 6, 0.600), (4, 6, 0.700), (5, 6, 0.800), (6, 6, 0.900),

-- Для 7-летних договоров
(1, 7, 0.000), (2, 7, 0.000), (3, 7, 0.500), (4, 7, 0.600), (5, 7, 0.700), (6, 7, 0.800), (7, 7, 0.900),

-- Для 8-летних договоров
(1, 8, 0.000), (2, 8, 0.000), (3, 8, 0.400), (4, 8, 0.500), (5, 8, 0.600), (6, 8, 0.700), (7, 8, 0.800), (8, 8, 0.900),

-- Для 9-летних договоров
(1, 9, 0.000), (2, 9, 0.000), (3, 9, 0.300), (4, 9, 0.400), (5, 9, 0.500), (6, 9, 0.600), (7, 9, 0.700), (8, 9, 0.800), (9, 9, 0.900),

-- Для 10-летних договоров
(1, 10, 0.000), (2, 10, 0.000), (3, 10, 0.200), (4, 10, 0.300), (5, 10, 0.400), (6, 10, 0.500), (7, 10, 0.600), (8, 10, 0.700), (9, 10, 0.800), (10, 10, 0.900),

-- Для 11-летних договоров
(1, 11, 0.000), (2, 11, 0.000), (3, 11, 0.100), (4, 11, 0.200), (5, 11, 0.300), (6, 11, 0.400), (7, 11, 0.500), (8, 11, 0.600), (9, 11, 0.700), (10, 11, 0.800), (11, 11, 0.900),

-- Для 12-летних договоров
(1, 12, 0.000), (2, 12, 0.000), (3, 12, 0.100), (4, 12, 0.200), (5, 12, 0.300), (6, 12, 0.400), (7, 12, 0.500), (8, 12, 0.600), (9, 12, 0.700), (10, 12, 0.800), (11, 12, 0.900), (12, 12, 1.000),

-- Для 13-летних договоров
(1, 13, 0.000), (2, 13, 0.000), (3, 13, 0.100), (4, 13, 0.200), (5, 13, 0.300), (6, 13, 0.400), (7, 13, 0.500), (8, 13, 0.600), (9, 13, 0.700), (10, 13, 0.800), (11, 13, 0.900), (12, 13, 1.000), (13, 13, 1.000),

-- Для 14-летних договоров
(1, 14, 0.000), (2, 14, 0.000), (3, 14, 0.100), (4, 14, 0.200), (5, 14, 0.300), (6, 14, 0.400), (7, 14, 0.500), (8, 14, 0.600), (9, 14, 0.700), (10, 14, 0.800), (11, 14, 0.900), (12, 14, 1.000), (13, 14, 1.000), (14, 14, 1.000),

-- Для 15-летних договоров
(1, 15, 0.000), (2, 15, 0.000), (3, 15, 0.100), (4, 15, 0.200), (5, 15, 0.300), (6, 15, 0.400), (7, 15, 0.500), (8, 15, 0.600), (9, 15, 0.700), (10, 15, 0.800), (11, 15, 0.900), (12, 15, 1.000), (13, 15, 1.000), (14, 15, 1.000), (15, 15, 1.000),

-- Для 16-летних договоров  
(1, 16, 0.000), (2, 16, 0.000), (3, 16, 0.100), (4, 16, 0.200), (5, 16, 0.300), (6, 16, 0.400), (7, 16, 0.500), (8, 16, 0.600), (9, 16, 0.700), (10, 16, 0.800), (11, 16, 0.900), (12, 16, 1.000), (13, 16, 1.000), (14, 16, 1.000), (15, 16, 1.000), (16, 16, 1.000),

-- Для 17-летних договоров
(1, 17, 0.000), (2, 17, 0.000), (3, 17, 0.100), (4, 17, 0.200), (5, 17, 0.300), (6, 17, 0.400), (7, 17, 0.500), (8, 17, 0.600), (9, 17, 0.700), (10, 17, 0.800), (11, 17, 0.900), (12, 17, 1.000), (13, 17, 1.000), (14, 17, 1.000), (15, 17, 1.000), (16, 17, 1.000), (17, 17, 1.000),

-- Для 18-летних договоров
(1, 18, 0.000), (2, 18, 0.000), (3, 18, 0.100), (4, 18, 0.200), (5, 18, 0.300), (6, 18, 0.400), (7, 18, 0.500), (8, 18, 0.600), (9, 18, 0.700), (10, 18, 0.800), (11, 18, 0.900), (12, 18, 1.000), (13, 18, 1.000), (14, 18, 1.000), (15, 18, 1.000), (16, 18, 1.000), (17, 18, 1.000), (18, 18, 1.000),

-- Для 19-летних договоров
(1, 19, 0.000), (2, 19, 0.000), (3, 19, 0.100), (4, 19, 0.200), (5, 19, 0.300), (6, 19, 0.400), (7, 19, 0.500), (8, 19, 0.600), (9, 19, 0.700), (10, 19, 0.800), (11, 19, 0.900), (12, 19, 1.000), (13, 19, 1.000), (14, 19, 1.000), (15, 19, 1.000), (16, 19, 1.000), (17, 19, 1.000), (18, 19, 1.000), (19, 19, 1.000),

-- Для 20-летних договоров
(1, 20, 0.000), (2, 20, 0.000), (3, 20, 0.100), (4, 20, 0.200), (5, 20, 0.300), (6, 20, 0.400), (7, 20, 0.500), (8, 20, 0.600), (9, 20, 0.700), (10, 20, 0.800), (11, 20, 0.900), (12, 20, 1.000), (13, 20, 1.000), (14, 20, 1.000), (15, 20, 1.000), (16, 20, 1.000), (17, 20, 1.000), (18, 20, 1.000), (19, 20, 1.000), (20, 20, 1.000);

-- =============================================================================
-- ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ ИЗ EXCEL
-- =============================================================================

-- Обновляем настройки на основе данных из Excel
UPDATE nsj_calculator_settings SET setting_value = '960000' WHERE setting_key = 'min_premium_amount';
UPDATE nsj_calculator_settings SET setting_value = '6000000' WHERE setting_key = 'default_insurance_sum';

-- Добавляем специфичные для программы настройки
INSERT INTO nsj_calculator_settings (setting_key, setting_value, description, value_type) VALUES
('calculation_base_rate', '0.25', 'Базовая ставка для расчетов', 'decimal'),
('program_version', 'v.25.2.1', 'Версия калькулятора из Excel', 'string'),
('excel_source_file', 'Калькулятор НСЖ Забота о будущем Ультра_v.25.2.1.xlsx', 'Исходный Excel файл', 'string'),
('last_data_update', CURRENT_DATE::text, 'Дата последнего обновления данных', 'string'),
('default_calculation_type', 'from_premium', 'Тип расчета по умолчанию', 'string'),
('supports_tax_calculation', 'true', 'Поддержка расчета налогового вычета', 'boolean'),
('supports_redemption_calculation', 'true', 'Поддержка расчета выкупных сумм', 'boolean'),
('age_calculation_precision', 'months', 'Точность расчета возраста', 'string')
ON CONFLICT (setting_key) DO UPDATE SET 
    setting_value = EXCLUDED.setting_value,
    updated_at = CURRENT_TIMESTAMP;

-- =============================================================================
-- ПРОВЕРОЧНЫЕ ЗАПРОСЫ
-- =============================================================================

-- Проверяем количество загруженных записей
DO $$
DECLARE
    risk_count INTEGER;
    redemption_count INTEGER;
    settings_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO risk_count FROM nsj_risk_rates;
    SELECT COUNT(*) INTO redemption_count FROM nsj_redemption_rates;
    SELECT COUNT(*) INTO settings_count FROM nsj_calculator_settings;
    
    RAISE INFO 'Загружено записей:';
    RAISE INFO '- Тарифных коэффициентов: %', risk_count;
    RAISE INFO '- Коэффициентов выкупа: %', redemption_count;
    RAISE INFO '- Настроек калькулятора: %', settings_count;
    
    IF risk_count = 0 OR redemption_count = 0 THEN
        RAISE EXCEPTION 'Ошибка загрузки данных!';
    END IF;
END $$;

-- Создаем индексы для оптимизации запросов
CREATE INDEX IF NOT EXISTS idx_nsj_risk_exact_age ON nsj_risk_rates (age_from) WHERE age_from = age_to;
CREATE INDEX IF NOT EXISTS idx_nsj_redemption_lookup ON nsj_redemption_rates (contract_term, contract_year);

-- Добавляем комментарии к данным
COMMENT ON TABLE nsj_risk_rates IS 'Тарифные коэффициенты из Excel листа "к_Тарифы по рискам"';
COMMENT ON TABLE nsj_redemption_rates IS 'Коэффициенты выкупа из Excel листа "к_Выкупные суммы"';

-- Проверочный запрос для тестирования
-- SELECT 'Данные загружены успешно!' as status;